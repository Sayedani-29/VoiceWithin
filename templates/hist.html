<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VoiceWithin ‚Äî History</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'DM Sans', Arial, sans-serif;
      background-color: #234;
      color: white;
    }

    /* ‚ïê‚ïê NAVBAR ‚ïê‚ïê */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 32px;
      height: 64px;
      background: white;
      border-bottom: 1px solid #f0f0f0;
      box-shadow: 0 1px 16px rgba(0,0,0,0.06);
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 22px;
      color: #223344;
      text-decoration: none;
      flex-shrink: 0;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .nav-item { position: relative; }

    .nav-item > a {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #555;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s, background 0.2s;
      white-space: nowrap;
    }
    .nav-item > a:hover { color: #223344; background: #f4f4f4; }

    .dropdown-content {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: white;
      border: 1px solid #ebebeb;
      border-radius: 12px;
      overflow: hidden;
      min-width: 160px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      z-index: 2000;
    }
    .dropdown-content a {
      display: block;
      padding: 10px 16px;
      font-size: 13px;
      color: #555;
      text-decoration: none;
      transition: background 0.15s;
    }
    .dropdown-content a:hover { background: #f6f6f6; color: #223344; }
    .nav-item:hover .dropdown-content { display: block; }
    .user-dropdown { left: auto; right: 0; }

    .user-icon {
      width: 34px; height: 34px;
      border-radius: 50%;
      background: #f4f4f4;
      border: 1px solid #e0e0e0;
      display: flex; justify-content: center; align-items: center;
      cursor: pointer; font-size: 16px;
      transition: background 0.2s;
    }
    .user-icon:hover { background: #ebebeb; }

    /* Hamburger ‚Äî hidden on desktop */
    .hamburger {
      display: none;
      flex-direction: column;
      gap: 5px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 6px 4px;
      flex-shrink: 0;
    }
    .hamburger span {
      display: block;
      width: 22px; height: 2px;
      background: #223344;
      border-radius: 2px;
      transition: all 0.3s;
    }
    .hamburger.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
    .hamburger.open span:nth-child(2) { opacity: 0; }
    .hamburger.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

    /* ‚ïê‚ïê MAIN ‚ïê‚ïê */
    main {
      padding: 30px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .month { margin-bottom: 36px; text-align: left; }
    .month h3 {
      margin-bottom: 14px;
      font-size: 20px;
      font-weight: bold;
      border-bottom: 1px solid rgba(255,255,255,0.15);
      padding-bottom: 8px;
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }

    .entry {
      background-color: white;
      color: black;
      border-radius: 12px;
      padding: 14px 10px;
      text-align: center;
      font-weight: bold;
      position: relative;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .entry:hover { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    .entry span { display: block; font-size: 28px; margin-bottom: 4px; }

    .entry-buttons {
      margin-top: 10px;
      display: flex;
      justify-content: space-around;
      gap: 4px;
      flex-wrap: wrap;
    }
    .entry-buttons button {
      background-color: #234; color: white;
      border: none; border-radius: 6px;
      padding: 6px 10px; font-size: 12px;
      cursor: pointer; transition: background 0.3s;
    }
    .entry-buttons button:hover { background-color: #456; }

    .empty-msg {
      text-align: center; margin-top: 100px;
      color: #ccc; font-style: italic;
    }

    /* ‚ïê‚ïê MODAL ‚ïê‚ïê */
    .modal {
      position: fixed; inset: 0;
      background-color: rgba(0,0,0,0.6);
      display: flex; justify-content: center; align-items: center;
      z-index: 3000; padding: 16px;
    }
    .modal-content {
      background-color: #fefefe; color: #123;
      width: 100%; max-width: 500px;
      border-radius: 15px; padding: 25px 30px;
      text-align: center; position: relative;
      animation: fadeIn 0.3s ease-in-out;
      max-height: 90vh; overflow-y: auto;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to   { opacity: 1; transform: scale(1); }
    }
    .modal-content h2 { margin-bottom: 5px; }
    .modal-content p  { color: gray; margin-bottom: 15px; }
    .mood-icons span  { font-size: 28px; margin: 0 5px; cursor: pointer; }
    textarea {
      width: 100%; padding: 10px;
      border-radius: 10px; border: 1px solid #ccc;
      resize: none; margin-bottom: 15px;
    }
    .modal-buttons button {
      background-color: #234; color: white;
      border: none; padding: 8px 16px;
      border-radius: 20px; cursor: pointer; margin: 5px;
    }
    .modal-buttons button:hover { background-color: #456; }
    .close-btn {
      position: absolute; top: 12px; right: 18px;
      font-size: 22px; cursor: pointer; color: #123;
    }
    .hidden { display: none; }

    /* ‚ïê‚ïê MOBILE ‚â§ 640px ‚ïê‚ïê */
    @media (max-width: 640px) {
      .navbar { padding: 0 16px; }

      /* show hamburger */
      .hamburger { display: flex; }

      /* collapse nav */
      .nav-links {
        display: none;
        position: absolute;
        top: 64px; left: 0; right: 0;
        background: white;
        flex-direction: column;
        align-items: stretch;
        gap: 0;
        border-bottom: 1px solid #eee;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      }
      .nav-links.open { display: flex; }

      /* each item full-width */
      .nav-item { width: 100%; }
      .nav-item > a {
        border-radius: 0;
        padding: 14px 20px;
        border-bottom: 1px solid #f5f5f5;
        font-size: 15px;
      }

      /* disable hover dropdowns, use tap instead */
      .nav-item:hover .dropdown-content { display: none; }
      .dropdown-content {
        position: static;
        border: none; border-radius: 0;
        box-shadow: none; background: #fafafa;
        min-width: unset;
      }
      .dropdown-content a { padding: 12px 36px; font-size: 14px; }
      .nav-item.open-dd .dropdown-content { display: block; }

      /* user icon */
      .nav-item > .user-icon {
        margin: 10px 20px;
        border-radius: 8px;
        width: auto; height: auto;
        padding: 8px 14px;
      }

      /* page content */
      main { padding: 20px 14px; }
      .month h3 { font-size: 17px; }
      .month-grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 10px;
      }
      .entry span { font-size: 24px; }
      .modal-content { padding: 20px 16px; }
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <a class="logo">VoiceWithin</a>

    <button class="hamburger" id="hamburger" aria-label="Open menu">
      <span></span><span></span><span></span>
    </button>

    <div class="nav-links" id="navLinks">
      <div class="nav-item">
        <a href="/survey">Test</a>
      </div>
      <div class="nav-item" id="journalDd">
        <a>Journal ‚ñæ</a>
        <div class="dropdown-content">
          <a href="/journal">New Entry</a>
          <a href="/hist">History</a>
        </div>
      </div>
      <div class="nav-item">
        <a href="/chatbot">AI</a>
      </div>
      <div class="nav-item" id="userDd">
        <div class="user-icon">üë§</div>
        <div class="dropdown-content user-dropdown">
          <a href="/improve">Dashboard</a>
          <a href="/login">Log Out</a>
        </div>
      </div>
    </div>
  </nav>

  <main>
    <section id="history"></section>
    <p id="emptyMessage" class="empty-msg hidden">No journal entries yet.</p>

    <div id="journalModal" class="modal hidden">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">√ó</span>
        <h2 id="modalTitle" contenteditable="false"></h2>
        <p id="modalDate"></p>
        <div class="mood-icons">
          <span onclick="selectMood('neutral')">üòê</span>
          <span onclick="selectMood('happy')">üòä</span>
          <span onclick="selectMood('smile')">üòÑ</span>
          <span onclick="selectMood('angry')">üò°</span>
          <span onclick="selectMood('sad')">üò≠</span>
        </div>
        <textarea id="modalContent" rows="6" readonly></textarea>
        <div class="modal-buttons">
          <button id="saveBtn" onclick="saveEditedEntry()" class="hidden">Save</button>
          <button onclick="closeModal()">Cancel</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentEntryId = null;
    let editMode = false;
    let selectedMood = null;

    // ‚îÄ‚îÄ Navbar (fixed: navLinks not navRight, user-icon not profile-icon) ‚îÄ‚îÄ
    const hamburger = document.getElementById('hamburger');
    const navLinks  = document.getElementById('navLinks');

    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('open');
      navLinks.classList.toggle('open');
    });

    ['journalDd', 'userDd'].forEach(id => {
      const el = document.getElementById(id);
      const trigger = el.querySelector('a, .user-icon');
      trigger.addEventListener('click', e => {
        if (window.innerWidth <= 640) {
          e.preventDefault();
          el.classList.toggle('open-dd');
        }
      });
    });

    navLinks.querySelectorAll('.dropdown-content a').forEach(a => {
      a.addEventListener('click', () => {
        navLinks.classList.remove('open');
        hamburger.classList.remove('open');
      });
    });

    // ‚îÄ‚îÄ ALL LOGIC BELOW UNCHANGED ‚îÄ‚îÄ

    async function renderHistory() {
      const res = await fetch('/entries');
      const data = await res.json();
      const container = document.getElementById('history');
      const emptyMessage = document.getElementById('emptyMessage');
      container.innerHTML = '';
      if (!data.length) {
        emptyMessage.classList.remove('hidden');
        return;
      } else {
        emptyMessage.classList.add('hidden');
      }
      const grouped = {};
      data.forEach(entry => {
        const date = new Date(entry.created_at);
        if (isNaN(date)) return;
        const monthYear = date.toLocaleString('default', { month: 'long', year: 'numeric' });
        if (!grouped[monthYear]) grouped[monthYear] = [];
        grouped[monthYear].push(entry);
      });
      for (const [month, entries] of Object.entries(grouped)) {
        const monthDiv = document.createElement('div');
        monthDiv.className = 'month';
        monthDiv.innerHTML = `<h3>${month}</h3><div class="month-grid"></div>`;
        const grid = monthDiv.querySelector('.month-grid');
        entries.forEach(entry => {
          const date = new Date(entry.created_at);
          const day = date.getDate();
          const moodIcon = moodToEmoji(entry.mood);
          const div = document.createElement('div');
          div.className = 'entry';
          div.innerHTML = `
            <span>${moodIcon}</span>
            ${String(day).padStart(2, '0')}<br>
            ${entry.title}
            <div class="entry-buttons">
              <button onclick="openEntry('${entry._id}', false)">Open</button>
              <button onclick="openEntry('${entry._id}', true)">Edit</button>
              <button onclick="deleteEntry('${entry._id}')">Delete</button>
            </div>`;
          grid.appendChild(div);
        });
        container.appendChild(monthDiv);
      }
    }

    function moodToEmoji(mood) {
      switch (mood) {
        case 'neutral': return 'üòê';
        case 'happy':   return 'üòä';
        case 'smile':   return 'üòÑ';
        case 'angry':   return 'üò°';
        case 'sad':     return 'üò≠';
        default:        return 'üôÇ';
      }
    }

    async function openEntry(id, isEdit) {
      const res = await fetch('/entries');
      const data = await res.json();
      const entry = data.find(e => e._id === id);
      if (!entry) return;
      currentEntryId = id;
      editMode = isEdit;
      selectedMood = entry.mood;
      document.getElementById('modalTitle').innerText = entry.title;
      document.getElementById('modalDate').innerText = new Date(entry.created_at).toLocaleString();
      document.getElementById('modalContent').value = entry.content;
      document.getElementById('modalTitle').contentEditable = isEdit;
      document.getElementById('modalContent').readOnly = !isEdit;
      document.getElementById('saveBtn').classList.toggle('hidden', !isEdit);
      document.querySelectorAll('.mood-icons span').forEach(span => {
        span.style.opacity = (moodToEmoji(entry.mood) === span.innerText) ? "1" : "0.4";
      });
      let imgHTML = "";
      if (entry.images && entry.images.length) {
        imgHTML = entry.images.map(img => `<img src="${img}" width="80" style="border-radius:10px;margin:5px;">`).join("");
      }
      document.querySelector('.modal-content').insertAdjacentHTML("beforeend", `<div id="imagePreview">${imgHTML}</div>`);
      if (isEdit) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'modalImageInput';
        fileInput.multiple = true;
        fileInput.accept = 'image/*';
        document.querySelector('.modal-content').appendChild(fileInput);
      }
      document.getElementById('journalModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('journalModal').classList.add('hidden');
      document.getElementById('imagePreview')?.remove();
      document.getElementById('modalImageInput')?.remove();
    }

    function selectMood(mood) {
      if (!editMode) return;
      selectedMood = mood;
      document.querySelectorAll('.mood-icons span').forEach(span => {
        span.style.opacity = (moodToEmoji(mood) === span.innerText) ? "1" : "0.4";
      });
    }

    async function saveEditedEntry() {
      if (!currentEntryId) return;
      const formData = new FormData();
      formData.append('title', document.getElementById('modalTitle').innerText.trim());
      formData.append('content', document.getElementById('modalContent').value.trim());
      formData.append('mood', selectedMood);
      const fileInput = document.getElementById('modalImageInput');
      if (fileInput && fileInput.files.length > 0) {
        for (let i = 0; i < fileInput.files.length; i++) {
          formData.append('images', fileInput.files[i]);
        }
      }
      await fetch(`/edit/${currentEntryId}`, { method: 'POST', body: formData });
      closeModal();
      renderHistory();
    }

    async function deleteEntry(id) {
      if (!confirm("Are you sure you want to delete this entry?")) return;
      const res = await fetch(`/delete/${id}`, { method: "POST" });
      const data = await res.json();
      if (!data.success) { alert("Delete failed."); return; }
      renderHistory();
    }

    renderHistory();
  </script>

</body>
</html>